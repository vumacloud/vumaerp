<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!--
    POS Views for Kenya eTIMS Integration

    IMPORTANT: All views use careful xpath expressions that target elements
    known to exist in Odoo 17 point_of_sale module views.
    -->

    <!-- ==================== POS ORDER VIEWS ==================== -->

    <!-- POS Order Form View Extension -->
    <record id="view_pos_order_form_etims" model="ir.ui.view">
        <field name="name">pos.order.form.etims</field>
        <field name="model">pos.order</field>
        <field name="inherit_id" ref="point_of_sale.view_pos_pos_form"/>
        <field name="priority">99</field>
        <field name="arch" type="xml">
            <!-- Add eTIMS submit button in header -->
            <xpath expr="//header" position="inside">
                <button name="action_submit_etims" type="object"
                        string="Submit to eTIMS"
                        class="btn-primary"
                        invisible="state not in ('paid', 'done', 'invoiced') or etims_submitted"/>
            </xpath>

            <!-- Add eTIMS tab in notebook -->
            <xpath expr="//notebook" position="inside">
                <page string="eTIMS Kenya" name="etims_tab">
                    <group>
                        <group string="Submission Status">
                            <field name="etims_submitted" readonly="1"/>
                            <field name="etims_submit_date" readonly="1"/>
                            <field name="etims_submission_error" readonly="1"
                                   invisible="not etims_submission_error"/>
                        </group>
                        <group string="eTIMS Receipt">
                            <field name="etims_sdc_id" readonly="1"/>
                            <field name="etims_rcpt_no" readonly="1"/>
                        </group>
                    </group>
                    <group string="Refund Information" invisible="amount_total &gt;= 0">
                        <field name="etims_refund_reason"/>
                        <field name="etims_original_order_id"/>
                    </group>
                    <group string="Technical Details" invisible="not etims_submitted">
                        <field name="etims_intrl_data" readonly="1"/>
                        <field name="etims_rcpt_sign" readonly="1"/>
                        <field name="etims_response" readonly="1"/>
                    </group>
                </page>
            </xpath>
        </field>
    </record>

    <!-- POS Order Tree View Extension -->
    <record id="view_pos_order_tree_etims" model="ir.ui.view">
        <field name="name">pos.order.tree.etims</field>
        <field name="model">pos.order</field>
        <field name="inherit_id" ref="point_of_sale.view_pos_order_tree"/>
        <field name="priority">99</field>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='state']" position="after">
                <field name="etims_submitted" string="eTIMS" optional="show" readonly="1"/>
                <field name="etims_sdc_id" string="SDC ID" optional="hide" readonly="1"/>
            </xpath>
        </field>
    </record>

    <!-- POS Order Search View Extension -->
    <record id="view_pos_order_search_etims" model="ir.ui.view">
        <field name="name">pos.order.search.etims</field>
        <field name="model">pos.order</field>
        <field name="inherit_id" ref="point_of_sale.view_pos_order_filter"/>
        <field name="priority">99</field>
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='session']" position="after">
                <separator/>
                <filter string="eTIMS Submitted" name="etims_submitted"
                        domain="[('etims_submitted', '=', True)]"/>
                <filter string="eTIMS Pending" name="etims_pending"
                        domain="[('etims_submitted', '=', False), ('state', 'in', ['paid', 'done', 'invoiced'])]"/>
                <filter string="eTIMS Failed" name="etims_failed"
                        domain="[('etims_submitted', '=', False), ('etims_submission_error', '!=', False)]"/>
            </xpath>
        </field>
    </record>

    <!-- ==================== POS SESSION VIEWS ==================== -->

    <!-- POS Session Form View Extension -->
    <record id="view_pos_session_form_etims" model="ir.ui.view">
        <field name="name">pos.session.form.etims</field>
        <field name="model">pos.session</field>
        <field name="inherit_id" ref="point_of_sale.view_pos_session_form"/>
        <field name="priority">99</field>
        <field name="arch" type="xml">
            <!-- Add button in header -->
            <xpath expr="//header" position="inside">
                <button name="action_submit_pending_etims" type="object"
                        string="Submit Pending to eTIMS"
                        class="btn-secondary"
                        invisible="state != 'opened'"/>
            </xpath>

            <!-- Add stat buttons using sheet position if button_box exists -->
            <xpath expr="//sheet" position="inside">
                <group string="eTIMS Submission Status" col="4">
                    <field name="etims_orders_submitted" readonly="1"/>
                    <field name="etims_orders_pending" readonly="1"/>
                    <field name="etims_orders_failed" readonly="1"/>
                    <field name="etims_submission_complete" readonly="1"/>
                </group>
            </xpath>
        </field>
    </record>

    <!-- ==================== POS CONFIG VIEWS ==================== -->

    <!--
    POS Config Form View Extension

    NOTE: We add company_id as invisible field first, then use it in modifiers.
    This is required because Odoo validates that fields used in modifiers exist in the view.
    -->
    <record id="view_pos_config_form_etims" model="ir.ui.view">
        <field name="name">pos.config.form.etims</field>
        <field name="model">pos.config</field>
        <field name="inherit_id" ref="point_of_sale.pos_config_view_form"/>
        <field name="priority">99</field>
        <field name="arch" type="xml">
            <!-- First, add company_id as invisible field so it can be used in modifiers -->
            <xpath expr="//sheet" position="inside">
                <field name="company_id" invisible="1"/>
                <group string="Kenya eTIMS Settings"
                       name="etims_settings"
                       invisible="company_id.country_id.code != 'KE'">
                    <group>
                        <field name="etims_auto_submit"/>
                        <field name="etims_block_on_failure"/>
                    </group>
                    <group>
                        <div class="text-muted">
                            <p><strong>Auto-submit:</strong> Automatically submit POS orders to KRA eTIMS when payment is completed.</p>
                            <p><strong>Block on failure:</strong> If enabled, POS operations will be blocked if eTIMS submission fails.</p>
                        </div>
                    </group>
                </group>
            </xpath>
        </field>
    </record>

    <!-- ==================== ACTIONS ==================== -->

    <!-- Action to view orders pending eTIMS submission -->
    <record id="action_pos_orders_pending_etims" model="ir.actions.act_window">
        <field name="name">POS Orders Pending eTIMS</field>
        <field name="res_model">pos.order</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[
            ('etims_submitted', '=', False),
            ('state', 'in', ['paid', 'done', 'invoiced'])
        ]</field>
        <field name="context">{'search_default_etims_pending': 1}</field>
    </record>

    <!-- Action to view orders with eTIMS errors -->
    <record id="action_pos_orders_etims_failed" model="ir.actions.act_window">
        <field name="name">POS Orders eTIMS Failed</field>
        <field name="res_model">pos.order</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[
            ('etims_submitted', '=', False),
            ('etims_submission_error', '!=', False)
        ]</field>
    </record>

</odoo>
